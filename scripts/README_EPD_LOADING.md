# EPD Loading Scripts

This directory contains scripts for loading and managing EPD (Environmental Product Declaration) data in the vector store.

## Quick Start

### 1. Verify System Readiness

```bash
python scripts/verify_system_ready.py
```

This checks:
- Database connectivity
- pgvector extension
- EC3 API credentials
- Embedding model
- System resources

### 2. Load EPDs

#### Option A: Using the Shell Wrapper (Easiest)

```bash
./scripts/run_comprehensive_epd_loader.sh
```

This will:
1. Verify system readiness
2. Ask for confirmation
3. Load all EPDs with comprehensive tracking
4. Offer to generate a summary report

#### Option B: Using Python Directly

```bash
# Load all EPDs
python scripts/load_epds_comprehensive.py

# Test with limited number
python scripts/load_epds_comprehensive.py --limit 100

# Skip existing EPDs
python scripts/load_epds_comprehensive.py --skip-existing
```

### 3. Generate Summary Report

```bash
# Display on console
python scripts/epd_summary_report.py

# Save to file
python scripts/epd_summary_report.py --output-file report.txt

# Export as JSON
python scripts/epd_summary_report.py --format json --output-file report.json
```

## Available Scripts

### Core Scripts

| Script | Purpose | Usage |
|--------|---------|-------|
| `verify_system_ready.py` | Check system configuration | `python scripts/verify_system_ready.py` |
| `load_epds_comprehensive.py` | Load EPDs with detailed tracking | `python scripts/load_epds_comprehensive.py [options]` |
| `epd_summary_report.py` | Generate summary of loaded EPDs | `python scripts/epd_summary_report.py [options]` |
| `run_comprehensive_epd_loader.sh` | Convenience wrapper | `./scripts/run_comprehensive_epd_loader.sh` |

### Legacy Scripts

| Script | Purpose |
|--------|---------|
| `load_epds_to_vector_store.py` | Original loader (less detailed logging) |
| `run_epd_loader.sh` | Original shell wrapper |
| `import_ec3_epds.py` | Import specific EPDs |
| `query_epd_vector_store.py` | Test semantic search |

## Command-Line Options

### load_epds_comprehensive.py

```
--limit N             Load only N EPDs (default: all)
--batch-size N        Process in batches of N (default: 50)
--skip-existing       Skip EPDs already in database
--log-level LEVEL     Set logging level (DEBUG, INFO, WARNING, ERROR)
```

Examples:
```bash
# Load first 100 EPDs for testing
python scripts/load_epds_comprehensive.py --limit 100

# Resume loading, skipping already loaded EPDs
python scripts/load_epds_comprehensive.py --skip-existing

# Large batch size for faster processing (more memory)
python scripts/load_epds_comprehensive.py --batch-size 100

# Quiet mode (warnings and errors only)
python scripts/load_epds_comprehensive.py --log-level WARNING
```

### epd_summary_report.py

```
--output-file FILE    Save report to file
--format FORMAT       Output format (text or json)
```

Examples:
```bash
# Display report on console
python scripts/epd_summary_report.py

# Save to text file
python scripts/epd_summary_report.py --output-file reports/summary.txt

# Export as JSON
python scripts/epd_summary_report.py --format json --output-file reports/summary.json
```

## Output Files

### Log Files (in `logs/` directory)

- `epd_loading_detailed_TIMESTAMP.log` - Every operation logged
- `epd_loading_summary_TIMESTAMP.log` - Major milestones only
- `epd_details_TIMESTAMP.jsonl` - JSON Lines format with EPD metadata

### Reports

Generated by `epd_summary_report.py`:
- Console output or saved to specified file
- Includes statistics, breakdowns, and recommendations

## Monitoring Progress

### Real-Time Console

Watch the live output showing:
- Batch progress with progress bars
- Individual EPD processing details
- Statistics after each batch

### Tail Log Files

```bash
# Watch detailed log
tail -f logs/epd_loading_detailed_*.log

# Watch summary log
tail -f logs/epd_loading_summary_*.log

# Count EPDs loaded so far
wc -l logs/epd_details_*.jsonl
```

### Database Queries

```bash
# Connect to database
psql -U mothra -d mothra

# Count EPDs
SELECT COUNT(*) FROM carbon_entities;

# Count embeddings
SELECT COUNT(*) FROM carbon_entities WHERE embedding IS NOT NULL;

# Recent EPDs
SELECT name, created_at FROM carbon_entities ORDER BY created_at DESC LIMIT 10;
```

## Typical Workflow

1. **First Time Setup:**
   ```bash
   # Verify everything is configured
   python scripts/verify_system_ready.py

   # Test with small number
   python scripts/load_epds_comprehensive.py --limit 100

   # Check results
   python scripts/epd_summary_report.py
   ```

2. **Production Load (All EPDs):**
   ```bash
   # Load everything
   ./scripts/run_comprehensive_epd_loader.sh

   # Or use Python directly
   python scripts/load_epds_comprehensive.py
   ```

3. **Incremental Updates:**
   ```bash
   # Load only new EPDs
   python scripts/load_epds_comprehensive.py --skip-existing
   ```

4. **Verification:**
   ```bash
   # Generate report
   python scripts/epd_summary_report.py --output-file reports/summary_$(date +%Y%m%d).txt

   # Test search
   python scripts/query_epd_vector_store.py "low carbon concrete"
   ```

## Troubleshooting

### Database Not Running

```bash
# Start PostgreSQL
docker compose up -d postgres

# Verify
docker compose ps
```

### EC3 API Issues

```bash
# Check credentials in .env
cat .env | grep EC3

# Test connection
python scripts/verify_system_ready.py
```

### Out of Memory

```bash
# Reduce batch size
python scripts/load_epds_comprehensive.py --batch-size 10

# Or process in chunks
python scripts/load_epds_comprehensive.py --limit 1000
python scripts/load_epds_comprehensive.py --limit 1000 --skip-existing
# Repeat...
```

### Slow Performance

- Use GPU if available (check CUDA)
- Increase batch size (if you have RAM)
- Reduce logging: `--log-level WARNING`
- Check database disk I/O

## Performance Expectations

On a typical system (4-core CPU, 16GB RAM, SSD):

- **Fetching:** ~100 EPDs/second from EC3 API
- **Processing:** ~5-10 EPDs/second (including embedding)
- **Total Time:** ~2-4 hours for 90,000 EPDs

With GPU:
- **Processing:** ~15-25 EPDs/second
- **Total Time:** ~1-2 hours for 90,000 EPDs

## For More Information

See the complete guide:
- `EPD_LOADING_COMPLETE_GUIDE.md` - Comprehensive documentation

See EC3 integration docs:
- `EC3_INTEGRATION_GUIDE.md` - API integration details
- `EC3_AUTHENTICATION_GUIDE.md` - Credential setup

See chunking docs:
- `CHUNKING_IMPLEMENTATION.md` - Text chunking strategy

---

*Last Updated: 2025-01-27*
